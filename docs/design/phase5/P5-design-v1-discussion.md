# Phase 5 设计方案讨论记录

## 讨论时间
2026-03-02

## 参与方
- 产品负责人
- OpenClaw (技术架构)

---

## 讨论要点

### 1. 实时行情的需求确认

**原方案**: 不做实时行情，日终数据足够

**调整**: 
- ✅ **需要实时行情**，但只针对**用户自选基金**
- ✅ **实时估值**：每10分钟拉取一次
- ✅ **存储当日点位**：用于绘制当日行情走势
- ❌ **不做全市场实时行情**（区别于其他软件）

**原因**:
- 市面上大部分软件已不能提供实时行情
- 用户有强烈需求看当日走势
- 只拉取自选的几十只，数据量可控

### 2. 数据存储策略

**当日点位数据**:
```sql
-- 实时估值快照表
CREATE TABLE fund_estimate_intraday (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    fund_code VARCHAR(10) NOT NULL,
    estimate_time DATETIME NOT NULL,  -- 估值时间（每10分钟）
    estimate_nav DECIMAL(10,4),       -- 实时估值
    estimate_change DECIMAL(8,4),     -- 估值涨跌幅%
    actual_nav DECIMAL(10,4),         -- 实际净值（收盘后更新）
    trade_date DATE NOT NULL,         -- 交易日期
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_fund_time (fund_code, estimate_time)
) PARTITION BY RANGE (YEAR(trade_date)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

**数据量估算**:
- 假设用户关注 50 只基金
- 每10分钟一条 = 每天 6条/小时 × 4小时（9:30-11:30, 13:00-15:00）= 24条/只/天
- 50只 × 24条 = 1200条/天
- 一年约 44万条，分区表轻松处理

### 3. 系统核心定位确认

**V1.0（当前）**: 基于规则的辅助决策
- 估值分位规则
- 回撤控制规则
- 评分模型规则
- 给出买入/持有/卖出信号

**V2.0（未来）**: 规则回测优化
- 针对**不同规则组合**进行历史回测
- 寻找**最优参数组合**
- 例如：
  - 估值分位 < 20% 买入 vs < 30% 买入
  - 止损线 -10% vs -15%
  - 不同评分权重组合
- 输出最优策略配置

### 4. 技术架构调整

#### 实时估值采集流程
```
交易日 09:30-11:30, 13:00-15:00
    ↓ 每10分钟
Python 调度器（APScheduler）
    ↓ HTTP API
akshare 获取实时估值
    ↓
写入 fund_estimate_intraday
    ↓ WebSocket
推送前端实时更新
```

#### 存储策略
- **Redis**: 缓存最新估值（TTL 15分钟）
- **MySQL**: 持久化存储当日所有点位
- **前端**: 使用 WebSocket 接收实时推送，ECharts 绘制分时图

### 5. 功能优先级调整

| 优先级 | 功能 | 说明 |
|--------|------|------|
| P0 | 我的关注 | 核心基础功能 |
| P0 | 实时估值 | 用户强烈需求，10分钟间隔 |
| P1 | 当日走势图 | 基于实时估值数据绘制 |
| P1 | 持仓管理 | 精细化成本计算 |
| P1 | 基于规则的辅助决策 | V1核心 |
| P2 | 定投分析 | XIRR计算 |
| P3 | 规则回测（V2） | 后续版本 |

### 6. 与其他软件的差异化（更新）

| 功能 | 蚂蚁/天天基金 | 本系统 |
|------|--------------|--------|
| 全市场实时行情 | ✅ 有（但延时） | ❌ **无** - 只拉取自选股 |
| 自选实时估值 | ⚠️ 延时15分钟+ | ✅ **准实时** - 10分钟间隔 |
| 当日分时走势 | ✅ 有 | ✅ **有** - 基于估值数据 |
| 历史回测 | ❌ 无 | ✅ **V2核心** - 规则优化 |
| 板块分析 | ✅ 详细 | ❌ **无** - 跳转外部 |

---

## 待确认事项

1. **实时估值数据源确认**
   - akshare 是否支持准实时估值？
   - 是否需要备用数据源？
   - 节假日/非交易时间如何处理？

2. **WebSocket 推送策略**
   - 推送给所有在线用户？
   - 还是只推送给打开了详情页的用户？

3. **历史数据保留策略**
   - 当日点位保留多久？
   - 是否保留历史分时数据用于对比？

4. **V2回测范围**
   - 回测多久的历史数据？（建议3-5年）
   - 支持哪些规则组合？
   - 回测结果如何展示？

---

## 下一步行动

1. 确认上述待确认事项
2. 更新 Phase 5 详细设计文档
3. 开始 P5-01 关注列表功能开发
4. 同步调研 akshare 实时估值接口

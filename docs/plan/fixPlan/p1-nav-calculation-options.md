# P1: 交易净值计算逻辑 - 方案对比

## 问题本质

基金交易规则：
| 交易时间 | 净值确认日 | 说明 |
|---------|-----------|------|
| 工作日 15:00 前 | T 日 | 当日净值，晚上公布 |
| 工作日 15:00 后 | T+1 日 | 下一交易日净值 |
| 非工作日 | T+1 日 | 下一交易日净值 |

## 方案对比

### 方案 A: 简化版（推荐）
**思路**: 用户选择买入日期，系统次日自动填入实际净值

**实现**:
1. 交易时只记录份额，不记录价格
2. 次日系统根据实际净值更新交易记录
3. 持仓计算使用更新后的净值

**优点**: 简单，数据准确
**缺点**: 交易记录不能立即显示完整信息

```
用户操作: 2026-03-01 14:00 买入 1000 份
系统处理: 
  - 当日记录: 份额=1000, 价格=待确认, 金额=待确认
  - 次日更新: 价格=1.234(实际净值), 金额=1234
```

---

### 方案 B: 预估版
**思路**: 交易时使用预估净值，次日校正

**实现**:
1. 使用最近净值 + 涨跌幅预估当日净值
2. 次日用实际净值替换预估值
3. 显示时标注"预估"

**优点**: 用户体验好，立即看到预估金额
**缺点**: 预估可能不准，需要校正逻辑

---

### 方案 C: 时间精确版
**思路**: 精确记录交易时间点，自动计算净值日期

**实现**:
1. 添加 `trade_time` 字段
2. 后端根据时间判断使用哪天的净值
3. 如果是当日 15:00 前，标记为"待确认"

**数据库变更**:
```sql
ALTER TABLE portfolio_trade ADD COLUMN trade_time TIME;
ALTER TABLE portfolio_trade ADD COLUMN nav_date DATE COMMENT '实际使用的净值日期';
ALTER TABLE portfolio_trade ADD COLUMN confirm_status TINYINT DEFAULT 0 COMMENT '0=待确认,1=已确认';
```

**优点**: 最准确，符合实际交易规则
**缺点**: 实现复杂，需要定时任务更新

---

## 建议

**短期**: 采用 **方案 A**（简化版）
- 用户选择日期和份额
- 系统次日自动填充实际净值
- 简单可靠

**长期**: 演进为 **方案 C**（时间精确版）
- 增加交易时间选择
- 自动判断净值日期
- 支持待确认状态

## 需要你的决定

1. **采用哪个方案？**
2. **是否需要立即实现？** （还是先用简化版）
3. **是否需要显示预估收益？**

请告诉我你的选择，我立即实现。
